name: Block Direct Pushes to Main/Dev

on:
  push:
    branches:
      - main
      - dev

jobs:
  prevent_direct_push:
    runs-on: ubuntu-latest
    steps:
      - name: Check if commit is a direct push
        run: |
          echo "üîç Checking push to '${{ github.ref_name }}'..."

          # Get the commit message of the most recent commit in the push
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: \"$COMMIT_MSG\""

          # Regex to identify common GitHub PR merge commit messages
          # This covers "Merge pull request #..." and "Merge branch '...' into ..."
          # and also "Merge: ..." which can happen with some Git versions/configs.
          # We are looking for *any* merge commit that isn't a direct commit.
          # The important thing is to distinguish between a direct commit and a merge.

          # Check if the commit message indicates a merge from a pull request or a branch merge
          # If it IS a merge commit, we allow it. If it's NOT, we block it.
          if [[ "$COMMIT_MSG" =~ ^(Merge pull request #[0-9]+ from .*|Merge branch .* into .*|Merge: .* .*)$ ]]; then
            echo "‚úÖ Recognized merge commit. Allowing push."
            exit 0 # Allow the push
          else
            echo "‚ùå Direct commit detected to branch '${{ github.ref_name }}'."
            echo "Direct pushes to 'main' and 'dev' are strictly prohibited."
            echo "All changes must be made via pull requests."
            exit 1 # Block the push
          fi